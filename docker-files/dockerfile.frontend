FROM node:22

WORKDIR /app

RUN corepack enable && corepack prepare pnpm@latest --activate

COPY package.json pnpm-lock.yaml pnpm-workspace.yaml turbo.json  ./

COPY apps/web/package.json apps/web/
COPY packages/db/package.json packages/db/
COPY packages/zod/package.json packages/zod/
COPY packages/eslint-config/package.json packages/eslint-config/
COPY packages/typescript-config/package.json packages/typescript-config/
COPY packages/utilities/package.json packages/utilities/package.json

RUN pnpm install --frozen-lockfile

COPY packages/db packages/db
COPY packages/zod packages/zod
COPY packages/eslint-config packages/eslint-config
COPY packages/typescript-config packages/typescript-config
COPY packages/utilities packages/utilities
COPY apps/web apps/web

RUN  pnpm --filter db run db:generate

ARG NEXT_PUBLIC_BACKEND_DOMAIN
ENV NEXT_PUBLIC_BACKEND_DOMAIN=$NEXT_PUBLIC_BACKEND_DOMAIN

RUN pnpm run build

EXPOSE 3000

CMD ["pnpm", "-w", "--filter", "web", "start"]